customElements.get("dbtfy-upsell-bundles")||customElements.define("dbtfy-upsell-bundles",class extends HTMLElement{constructor(){super()}disconnectedCallback(){}connectedCallback(){this.loadBundle()}loadBundle(){this.setupVars(),this.specificBundle?this.upsellItem?(this.setUpSpecificBundle(),this.init()):this.remove():this.loadRecommendations()}setupVars(){({productId:this.productId,productHandler:this.productHandler,sectionId:this.sectionId,url:this.url,specificBundle:this.specificBundle,discountAmount:this.discountAmount,discountName:this.discountName,discountType:this.discountType,currency:this.currency,formId:this.formId,mobileMode:this.mobileMode}=this.dataset);const t=Debutify.widgets.upsell_bundles.blocks.filter((t=>t.product_trigger===this.productHandler));this.upsellItem=t.length>0?t[t.length-1]:null,this.url=`${this.url}&product_id=${this.productId}&section_id=${this.sectionId}`,this.upsellItem?(this.specificBundle=!0,this.discountName=this.upsellItem.discount_code,this.discountAmount=this.upsellItem.discount_amount,this.discountType=this.upsellItem.discount_type,"$"==this.discountType&&(this.discountAmount=100*this.discountAmount),this.querySelector("product-form").setAttribute("data-discount-code",this.upsellItem.discount_code)):this.specificBundle="false"==this.specificBundle,this.discount={name:this.discountName,amount:Number(this.discountAmount)||0,type:this.discountType},this.items=this.querySelectorAll(".dbtfy-upsell-bundles__item"),this.currency=this.currency,this.submitButton=this.querySelector(".product-form__submit"),this.formInput=this.querySelector(".product-variant-id"),this.selects=this.querySelectorAll('[name="id[]"]'),this.wrapper=document.getElementById("dbtfy-upsell-bundles-wrapper")}async setUpSpecificBundle(){const t=this.querySelectorAll(".dbtfy-upsell-bundle__list .dbtfy-upsell-bundles__item:nth-child(n+2)");t?.forEach((t=>{t.remove()})),this.upsellItem.product_offer_1&&await this.loadSpecificItem(this.upsellItem.product_offer_1),this.upsellItem.product_offer_2&&await this.loadSpecificItem(this.upsellItem.product_offer_2),this.upsellItem.product_offer_3&&await this.loadSpecificItem(this.upsellItem.product_offer_3),this.setupVars(),this.init()}async loadSpecificItem(t){let e=await Debutify.fetchProductMarkup(`/products/${t}?view=internal-upsell-item`),s=(new DOMParser).parseFromString(e,"text/html"),i=s.querySelector(".dbtfy-upsell-bundles__item");const l=s.querySelector(".dbtfy-upsell-bundles__item");l&&"true"==this.mobileMode&&l.classList.remove("grid--6-col-desktop","grid--6-col-tablet"),i&&(i.querySelectorAll("select").forEach((t=>{t.setAttribute("form",this.formId)})),i.querySelectorAll('input[type="radio"]').forEach((t=>{t.setAttribute("form",this.formId)})),this.querySelector(".dbtfy-upsell-bundle__list").appendChild(i))}loadRecommendations(){fetch(this.url).then((t=>t.text())).then((t=>{const e=document.createElement("div");e.innerHTML=t;const s=e.querySelector("dbtfy-upsell-bundles");s&&s.querySelectorAll(".dbtfy-upsell-bundles__item").length>1&&s?.innerHTML.trim().length&&(this.innerHTML=s.innerHTML,this.items=this.querySelectorAll(".dbtfy-upsell-bundles__item"),this.submitButton=this.querySelector(".product-form__submit"),this.formInput=this.querySelector(".product-variant-id"),this.selects=this.querySelectorAll('[name="id[]"]'),this.init(),this.removeAttribute("hidden"))})).catch((t=>{console.error(t)}))}init(){this.removeAttribute("hidden"),this.formInput.setAttribute("name","id[]"),this.formInput.disabled=!0,this.selects.forEach((t=>{t.addEventListener("change",this.updateItems.bind(this)),t.addEventListener("change",this.setTotalPrice.bind(this))})),this.updateItems(),this.setTotalPrice(),this.addEventToCheckbox(),this.setAttribute("data-insert-product",!0)}setTotalPrice(){let t=0,e=0,s=0,i=this.discount.amount;1==this.querySelectorAll(".dbtfy-upsell-bundles__item .dbtfy-upsell-product-item__checkbox:checked").length&&(i=0),this.items.forEach((e=>{if(!e.querySelector('[name="id[]"]').disabled){const s=this.getCurrentVariant(e)[0];t+=s.price}})),e="%"==this.discount.type?t*((100-i)/100):t-i,s=t-e,e<0&&(s=t,e=0),this.querySelector(".dbtfy-upsell-bundles__discount-price").textContent=t>0?this.moneyFormat(e):"",this.querySelector(".dbtfy-upsell-bundles__original-price").textContent=t>e?this.moneyFormat(t):"",this.querySelector(".dbtfy-upsell-bundles__save-price").innerHTML=s>0?`<span class="badge dbtfy-sale-badge">SAVE ${this.moneyFormat(s)}</span>`:"",this.submitButton.disabled=0==t}updateItems(){this.items.forEach(((t,e)=>{const s=this.getProduct(t),i=this.getCurrentVariant(t)[0],l=t.querySelector(".bundle__title .product-title"),r=i.price,u=i.compare_at_price||0;let c=`${s.title} | `;e>0&&(c=`<label for="dbtfy-upsell-product-item--${s.id}">${s.title}</label> | `),l.innerHTML=`${c}${i.title&&"Default Title"!=i.title?i.title+" | ":""}${this.moneyFormat(r)}${u>r?" <del>"+this.moneyFormat(u)+"</del>":""}`}))}getProduct(t){return JSON.parse(t.querySelector("[data-product]").innerHTML)}getCurrentVariant(t){const e=this.getProduct(t),s=t.querySelector('[name="id[]"]').value;return e.variants.filter((t=>t.id==s))}moneyFormat(t){return`${this.currency}${(t/100).toFixed(2)}`}addEventToCheckbox(){this.items.forEach((t=>{t.querySelector(".dbtfy-upsell-product-item__checkbox").addEventListener("change",(t=>{t.target.closest(".dbtfy-upsell-bundles__item").querySelector('[name="id[]"]').disabled=!t.target.checked,this.querySelector(`.dbtfy-upsell-bundle__media[data-product-id="${t.target.value}"]`).classList.toggle("disabled"),this.setTotalPrice()}))})),this.items.forEach((t=>{t.querySelector(".custom_checkbox")?.addEventListener("click",(t=>{t.preventDefault();const e=t.target.closest(".dbtfy-upsell-bundles__item").querySelector(".dbtfy-upsell-product-item__checkbox");e.checked=!e.checked,e.dispatchEvent(new Event("change",{bubbles:!0}))}))}))}});