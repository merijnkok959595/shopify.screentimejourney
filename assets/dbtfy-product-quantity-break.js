customElements.get("dbtfy-product-quantity-break")||customElements.define("dbtfy-product-quantity-break",class extends HTMLElement{constructor(){if(super(),this.data=Debutify.widgets["qty-breaks"],!this.data)return;this.productInfo=this.closest("product-info"),this.currency=Debutify.currency.symbol,this.enable_single_quantity=this.data.enable_single_quantity,this.currentVariant=this.dataset.currentVariant,this.currentVariantPrice=this.dataset.currentVariantPrice;const t=this.querySelector("[data-quantity-break-product]");t&&(this.product=JSON.parse(t.innerHTML),this.collections=JSON.parse(this.querySelector("[data-quantity-break-collection]").innerHTML),this.visibleBreaks=[],this.getVisibleBreaks(),this.visibleBreaks.length>0?(this.init(),subscribe(PUB_SUB_EVENTS.variantChange,this.handleVariantChange.bind(this)),subscribe(PUB_SUB_EVENTS.cartUpdate,this.handleCartUpdate.bind(this))):this.remove())}handleVariantChange({data:{variant:t}}){this.currentVariant=t.id,this.currentVariantPrice=t.price,this.init()}handleCartUpdate(){this.setFirstSingleBreak()}getVisibleBreaks(){const t=this.collections.map((t=>t.handle)),e=this.data.product_break.filter((e=>{switch(e.product_break_visibility){case"collection":return t.includes(e.product_break_collection);case"type":return e.product_break_types.toLowerCase().includes(this.product.type.toLowerCase());case"tag":return this.product.tags.some((t=>e.product_break_tags.toLowerCase().includes(t.toLowerCase())));case"product":return e.product_break_product===this.product.handle;case"all":return!0;default:return!1}}));0!==e.length&&(this.visibleBreaks=e.flatMap((t=>t.breaks.map((t=>({product_break_range:t.product_break_range,product_break_discount_code:t.product_break_discount_code,product_break_discount_type:t.product_break_discount_type,product_break_discount_amount:t.product_break_discount_amount,product_break_tag_1:t.product_break_tag_1,product_break_tag_1_background_color:t.product_break_tag_1_background_color,product_break_tag_1_text_color:t.product_break_tag_1_text_color,product_break_tag_1_border_color:t.product_break_tag_1_border_color,product_break_free_product:t.free_product,product_break_free_product_quantity:t.product_break_free_product_quantity,product_break_free_product_img:t.product_break_free_product_image,product_break_badge_style:t.product_break_badge_style,badge_title:t.badge_title,product_break_block_title:t.title,product_break_block_subtitle:t.subtitle}))))).sort(((t,e)=>t.product_break_range-e.product_break_range)))}setupDefaultBreak(t){if(0==this.enable_single_quantity)return"";const e=t.querySelector("dbtfy-product-quantity-single-break-template").cloneNode(!0);return Debutify.replaceVariables(e.innerHTML,{original_price:this.moneyFormat(this.currentVariantPrice),item_heading:Debutify.replaceVariables(this.data.single_quantity_text,{COUNT:1}),single_break_subtext:this.data.single_quantity_subtext})}async init(){try{const t=await Debutify.fetchProductMarkup(`/products/${this.product.handle}?view=internal-quantity-break`);if(!t)return null;{const e=(new DOMParser).parseFromString(t,"text/html").querySelector("body");let r=this.setupDefaultBreak(e);this.visibleBreaks.forEach((t=>{r+=this.renderQuantityBreaks(t,e,t.product_break_range)})),r=(new DOMParser).parseFromString(r,"text/html").body,this.innerHTML=r.innerHTML;const a=this.querySelector(".dbtfy-product-quantity-single-break .dbtfy-product-quantity-break--quantity.hidden:not(.has-only-variant)");a&&this.data.enable_variant_selector&&a.classList.remove("hidden");const i=this.querySelectorAll(".dbtfy-product-quantity-break--quantity__group");i.length>0&&(i.forEach((t=>{const e=t.querySelector("select");e&&e.addEventListener("change",(t=>{const e=t.target.closest(".dbtfy-product-quantity-break--quantity");this.calculateTotal(e)}))})),this.productInfo.querySelector("variant-selects")?.classList.add("hidden")),this.handleInputChange(),i.length>0&&i.forEach((t=>{this.calculateTotal(t)}))}}catch(t){console.error("Error initializing quantity breaks:",t)}}calculateTotal(t){const e=t.querySelector("select");if(e){const t=e.closest(".dbtfy-product-quantity-break--quantity").querySelectorAll("select"),r=e.closest(".dbtfy-product-quantity-break");let a=0,i=0,o=0;t.forEach((t=>{const e=t.dataset.type,r=parseFloat(t.dataset.amount),c=t.selectedOptions[0],u=parseFloat(c.getAttribute("data-price"));if(this.typeDiscount=!1,""!=e&&!isNaN(r)){let t="%"===e?u*(100-r)/100:u-100*r;i+=t,o+=u-t,this.typeDiscount=!0}a+=u})),this.typeDiscount?(r.querySelector(".dbtfy-product-quantity-break__right-price").innerHTML=this.moneyFormat(i),r.querySelector(".dbtfy-product-quantity-break__left-text").innerHTML=Debutify.replaceVariables(this.data.multiple_quantity_subtext,{SAVED_AMOUNT:this.moneyFormat(o)}),r.querySelector(".dbtfy-product-quantity-break__right-original-price").innerHTML=this.moneyFormat(a)):(r.querySelector(".dbtfy-product-quantity-break__right-original-price")?.classList.add("hidden"),r.querySelector(".dbtfy-product-quantity-break__left-text")?.classList.add("hidden"),r.querySelector(".dbtfy-product-quantity-break__right-price").innerHTML=this.moneyFormat(a))}}renderQuantityBreaks(t,e,r){const a=e.querySelector("dbtfy-product-quantity-break-template").cloneNode(!0),i=a.querySelector(".dbtfy-product-quantity-break--quantity.hidden"),o=t.product_break_range;if(o>1)for(let t=1;t<=o-1;t++){const t=i.querySelector(".dbtfy-product-quantity-break--quantity__group").cloneNode(!0);i.appendChild(t)}!i.classList.contains("has-only-variant")&&this.data.enable_variant_selector&&i.classList.remove("hidden");let c="%"==t.product_break_discount_type?this.currentVariantPrice*(100-t.product_break_discount_amount)/100:this.currentVariantPrice-100*t.product_break_discount_amount,u=this.currentVariantPrice-c;const n={random_number:Math.floor(1e6*Math.random()),range:t.product_break_range,free_product_title:t.product_break_free_product.title,free_product_available:!!t.product_break_free_product.available,free_product_id:t.product_break_free_product.available?t.product_break_free_product.variants[0].id:"",free_product_quantity:t.product_break_free_product.available?t.product_break_free_product_quantity:"",free_product_img:t.product_break_free_product_img?t.product_break_free_product_img:t.product_break_free_product.images,tag_1_border_color:t.product_break_tag_1_border_color,tag_1_background_color:t.product_break_tag_1_background_color,product_break_discount_type__variant:t.product_break_discount_type,product_break_discount_amount__variant:t.product_break_discount_amount,tag_1_text_color:t.product_break_tag_1_text_color,tag_1:t.product_break_tag_1,tag_1_breaks:Debutify.replaceVariables(t.product_break_tag_1,{DISCOUNT:this.moneyFormat(u)}),badge_title:t.badge_title,product_break_badge_style:t.product_break_badge_style,item_heading:Debutify.replaceVariables(t.product_break_block_title?t.product_break_block_title:this.data.multiple_quantity_text,{COUNT:t.product_break_range}),single_break_subtext:this.data.multiple_quantity_subtext,single_break_subtext_breaks:Debutify.replaceVariables(t.product_break_block_subtitle?t.product_break_block_subtitle:this.data.multiple_quantity_subtext,{SAVED_AMOUNT:this.moneyFormat(u)}),original_price:this.moneyFormat(this.currentVariantPrice),discounted_price:this.moneyFormat(c),discount_code:t.product_break_discount_code};return"simple"==t.product_break_badge_style&&a.querySelector(".mostpopular_conditionable")?.remove(),(!t.product_break_tag_1||r<=1)&&a.querySelector(".tag1_conditionable")?.remove(),"most_popular"==n.product_break_badge_style&&(n.badge_title=""),Debutify.replaceVariables(a.innerHTML,n)}handleInputChange(){const t=this.closest("product-info"),e=t.querySelector('input[name="quantity"]');e?e.addEventListener("change",(t=>{const e=t.target.value,r=this.querySelector(".dbtfy-product-quantity-break .dbtfy-product-quantity-break__radio:checked");r&&(r.checked=!1);let a=this.querySelector('.dbtfy-product-quantity-break:not(:first-child) .dbtfy-product-quantity-break__radio[value="'+e+'"]');0==this.enable_single_quantity&&(a=this.querySelector('.dbtfy-product-quantity-break .dbtfy-product-quantity-break__radio[value="'+e+'"]')),a?a.checked=!0:this.setFirstSingleBreak(e)})):t.querySelector(".product-form__buttons").insertAdjacentHTML("beforebegin",'\n            <input type="hidden" name="quantity" value="1">\n          '),this.querySelectorAll("input").forEach((e=>{e.addEventListener("change",(()=>{t.querySelector('[name="quantity"]').value=e.value}))}))}setFirstSingleBreak(t=1){if(0==this.enable_single_quantity)return"";const e=this.querySelector(".dbtfy-product-quantity-break:first-child");if(e){const r=e.querySelector(".dbtfy-product-quantity-break__radio");r.checked=!0,r.value=t;e.querySelector(".textcontent").innerHTML=Debutify.replaceVariables(this.data.single_quantity_text,{COUNT:t})}}moneyFormat(t){return`${this.currency}${(t/100).toFixed(2)}`}});